<?php
/**
 * Classe principale de l'application ProActiv
 * Architecture MVC simple pour hébergement mutualisé
 */

class Application
{
    private $config;
    private $db;
    private $router;
    private $request;
    
    public function __construct(array $config)
    {
        $this->config = $config;
        $this->initializeTimezone();
        $this->initializeDatabase();
        $this->initializeRouter();
        $this->initializeRequest();
    }
    
    /**
     * Lance l'application
     */
    public function run()
    {
        // Vérification de la maintenance
        if ($this->config['app']['maintenance']) {
            $this->showMaintenancePage();
            return;
        }
        
        // Headers de sécurité
        $this->setSecurityHeaders();
        
        // Routage de la requête
        $this->router->dispatch($this->request);
    }
    
    /**
     * Initialise le fuseau horaire
     */
    private function initializeTimezone()
    {
        date_default_timezone_set($this->config['app']['timezone']);
    }
    
    /**
     * Initialise la base de données
     */
    private function initializeDatabase()
    {
        try {
            $dsn = sprintf(
                'mysql:host=%s;port=%d;dbname=%s;charset=%s',
                $this->config['database']['host'],
                $this->config['database']['port'],
                $this->config['database']['name'],
                $this->config['database']['charset']
            );
            
            $this->db = new PDO(
                $dsn,
                $this->config['database']['username'],
                $this->config['database']['password'],
                $this->config['database']['options']
            );
            
        } catch (PDOException $e) {
            if ($this->config['app']['debug']) {
                throw new Exception("Erreur de connexion base de données: " . $e->getMessage());
            } else {
                throw new Exception("Erreur de connexion à la base de données");
            }
        }
    }
    
    /**
     * Initialise le routeur
     */
    private function initializeRouter()
    {
        require_once PROACTIV_ROOT . '/src/Router.php';
        $this->router = new Router($this);
    }
    
    /**
     * Initialise la requête
     */
    private function initializeRequest()
    {
        require_once PROACTIV_ROOT . '/src/Request.php';
        $this->request = new Request();
    }
    
    /**
     * Définit les headers de sécurité
     */
    private function setSecurityHeaders()
    {
        header('X-Content-Type-Options: nosniff');
        header('X-Frame-Options: DENY');
        header('X-XSS-Protection: 1; mode=block');
        header('Referrer-Policy: strict-origin-when-cross-origin');
        
        if (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on') {
            header('Strict-Transport-Security: max-age=31536000; includeSubDomains');
        }
    }
    
    /**
     * Affiche la page de maintenance
     */
    private function showMaintenancePage()
    {
        http_response_code(503);
        include PROACTIV_ROOT . '/templates/maintenance.php';
        exit;
    }
    
    /**
     * Getters pour les composants
     */
    public function getConfig($key = null)
    {
        if ($key === null) {
            return $this->config;
        }
        
        $keys = explode('.', $key);
        $value = $this->config;
        
        foreach ($keys as $k) {
            if (!isset($value[$k])) {
                return null;
            }
            $value = $value[$k];
        }
        
        return $value;
    }
    
    public function getDatabase()
    {
        return $this->db;
    }
    
    public function getRouter()
    {
        return $this->router;
    }
}
